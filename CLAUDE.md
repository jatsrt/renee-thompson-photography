# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Photography portfolio website for Renee Thompson Photography built with Next.js. Features dynamic gallery management with AWS S3 backend, Auth0 authentication, and automatic image processing via Lambda.

## Commands

### Development
```bash
npm run dev     # Start development server at http://localhost:3000
npm run build   # Production build
npm run start   # Start production server
npm run lint    # Run ESLint
```

### AWS Infrastructure (CDK)
```bash
cd aws/
npm install           # Install CDK dependencies
cdk deploy           # Deploy infrastructure to AWS
cdk diff             # Preview infrastructure changes
cdk synth            # Synthesize CloudFormation template
```

## Architecture

### Gallery System
The core feature is a dynamic, nested gallery system that reads from AWS S3:

- **Frontend**: `pages/galleries/[[...gallery]].tsx` - Catch-all route handling all gallery paths
- **API**: `pages/api/galleries/[[...gallery]].ts` - Lists S3 objects and returns folder structure
- **Fetcher**: `fetchers/useFetcherFolder.tsx` - SWR-based data fetching with TypeScript interfaces
- **Storage**: AWS S3 bucket stores original images and auto-generated previews

### Access Control
- **Middleware**: `middleware.ts` runs Auth0 middleware on all routes except static assets
- **Admin Access**: Users with `@reneethompson.photos` email domain get full access
- **Public Access**: Folders require `public.index` marker file to be visible to non-admins
- **Private Galleries**: Folders under `Private/` are admin-only unless marked public

### Media Processing Pipeline
1. Images uploaded to S3 trigger Lambda function (`aws/lib/gallery-construct.resize.ts`)
2. Lambda generates `.preview` versions using Sharp
3. CloudFront serves media from `media.reneethompson.photos`
4. Next.js rewrites `/media/*` to CloudFront distribution

### AWS Infrastructure (CDK)
Defined in `aws/lib/`:
- **S3 Bucket**: Stores gallery images with CORS configuration
- **CloudFront**: CDN for media delivery with custom domain
- **Lambda**: Automatic image resizing on upload (ARM64, 2GB memory)
- **Route53**: DNS records for `media.reneethompson.photos`
- **ACM**: SSL certificate for custom domain

### Authentication Flow
1. Auth0 middleware intercepts all requests (configured in `middleware.ts`)
2. Session data available via `auth0.getSession(req)` in API routes
3. Admin status checked by email domain: `user?.email?.endsWith("@reneethompson.photos")`
4. Auth0 client initialized in `lib/auth0.ts`

### Data Flow for Galleries
```
User navigates to /galleries/folder/subfolder
  → Next.js matches [[...gallery]].tsx route
  → Component calls useFetcherFolder("folder/subfolder/")
  → SWR fetches from /api/galleries/folder/subfolder
  → API queries S3 with ListObjectsV2
  → Returns: subFolders, items (.preview files), medias (.m3u8 files)
  → Frontend renders breadcrumbs, folder grid, and lightbox
```

## Key Files

### Configuration
- `next.config.js`: Flowbite plugin, media rewrites, SmugMug redirects
- `middleware.ts`: Auth0 middleware applied to all routes except static assets
- `postcss.config.js`: Tailwind CSS v4 PostCSS plugin

### Components
- `Layout.tsx`: Standard layout with navigation and footer
- `LayoutNoHead.tsx`: Layout without head tag (for pages with custom Head)
- `Navigation.tsx`: Main navigation component
- `MediaPlayer.tsx`: Video.js player for HLS streaming
- `ContactForm.tsx`: Formspree integration

### Environment Variables
Required for deployment:
- `MY_AWS_ACCESS_KEY_ID`: AWS credentials for S3 access
- `MY_AWS_SECRET_ACCESS_KEY`: AWS secret key
- `GALLERY_BUCKET_NAME`: S3 bucket name
- Auth0 variables (configured via Auth0 SDK)

## Tech Stack Notes

### Version Constraints
- **Next.js**: Currently on 15.5.6 (not 16.x) due to @auth0/nextjs-auth0 compatibility
- **React**: 19.2.0 (latest stable)
- **Tailwind CSS**: 4.1.16 (v4 with PostCSS plugin)
- When upgrading Next.js, verify Auth0 package supports the new version

### UI Framework
Uses Flowbite React components with Tailwind CSS v4. The `flowbite-react` package auto-generates `.flowbite-react/class-list.json` during builds.

### Image Handling
- Original images stored in S3 without extension
- `.preview` files generated by Lambda (resized versions)
- Metadata stored in S3 object metadata: `imageorientation`, `favorite`
- Download tracking stored in browser localStorage

### Video Support
- HLS streaming via Video.js and hls.js
- `.m3u8` files served from CloudFront
- Separate handling in API route (media vs items)

## Development Workflow

1. **Local Development**: Run `npm run dev` and test at localhost:3000
2. **Gallery Testing**: Requires valid AWS credentials in environment variables
3. **Auth Testing**: Requires Auth0 configuration (prod/dev tenants)
4. **Building**: Always run `npm run build` before deploying to catch type errors
5. **Infrastructure Changes**: Modify CDK code in `aws/`, then `cd aws && cdk deploy`

## Important Patterns

### Catch-all Routes
Both pages and API routes use `[[...gallery]]` pattern:
- Empty array (`[]`): Root galleries page
- Single segment (`['sports']`): `galleries/sports`
- Multiple segments (`['2024', 'spring']`): `galleries/2024/spring`

### State Management
- **SWR**: Data fetching with automatic revalidation
- **Immer**: Immutable state updates (e.g., download tracking)
- **localStorage**: Client-side persistence for downloads

### TypeScript
- Strict mode enabled
- Custom type `NextPageWithLayout` for pages with custom layouts
- Shared interfaces between API routes and fetchers (e.g., `Folder`, `Item`)
